const energyType={consumption:{colorScale:d3.scaleThreshold().domain([300,500,1e3,3e3,5e3,1e4]).range(d3.schemeBlues[7]),legend:"Consumption (TWh)",title:e=>`Global oil consumption (TWh) in ${e}`,unit:"TWh",perCapitaUnit:"MWh"},production:{colorScale:d3.scaleThreshold().domain([100,300,500,1e3,3e3,5e3]).range(d3.schemeGreens[7]),legend:"Production (TWh)",title:e=>`Global oil production (TWh) in ${e}`,unit:"TWh",perCapitaUnit:"MWh"},reserves:{colorScale:d3.scaleThreshold().domain([500,1e3,3e3,5e3,1e4,3e4]).range(d3.schemeOranges[7]),legend:"Reserves (Million Barrels)",title:e=>`Global oil reserves (Million Barrels) in ${e}`,unit:"Million Barrels",perCapitaUnit:"Barrels"}};let selectedEnergyType="consumption";const mapSvg=document.getElementById("map-chart"),d3MapSvg=d3.select(mapSvg),width=mapSvg.clientWidth,height=mapSvg.clientHeight,path=d3.geoPath(),data=d3.map(),worldmap="./Data/world.geojson",oilData="./Data/oil.json",legend=d3MapSvg.append("g").attr("id","legend"),x=d3.scaleLinear().domain([2.6,75.1]).rangeRound([600,860]),yearSlider=document.getElementById("year-slider"),energyBtn=document.getElementsByClassName("energy-btn"),mapTitle=document.getElementById("map-title"),countryListBox=document.getElementById("country-list-box");let selectedCountries=[];const projection=d3.geoRobinson().scale(height/3).translate([width/2,height/2+20]),tooltip=d3.select("body").append("div").attr("class","map-tooltip").style("opacity",0);function ready(e,t){for(const[e,n]of Object.entries(t[1]))data.set(e,n);const n=(e,t,n)=>{e.transition().duration(200).style("opacity",t).style("stroke",n)};function r(e){let t;t="number"==typeof t?this:document.querySelector(`path#${e.id}`),selectedCountries.includes(e.id)?(selectedCountries=selectedCountries.filter((t=>t!==e.id)),countryListBox.querySelector(`input[value="${e.id}"]`).checked=!1,0===selectedCountries.length?n(d3.selectAll(".Country"),1,"transparent"):n(d3.select(t),.5,"transparent")):(0===selectedCountries.length&&n(d3.selectAll(".Country"),.5,"transparent"),selectedCountries.push(e.id),countryListBox.querySelector(`input[value="${e.id}"]`).checked=!0,n(d3.select(t),1,"black")),updatePieChart(data.get(yearSlider.value),selectedEnergyType,selectedCountries)}const l=()=>{0!==selectedCountries.length&&(selectedCountries.length=0,countryListBox.querySelectorAll("input").forEach((e=>e.checked=!1)),n(d3.selectAll(".Country"),1,"transparent"),tooltip.transition().duration(300).style("opacity",0),updatePieChart(data.get(yearSlider.value),selectedEnergyType,[]))};document.getElementById("map-deselect-btn").addEventListener("click",(()=>{l()}));const a=(e,t)=>{const n=data.get(t);return e.value=n[e.id]?.[selectedEnergyType],e.population=n[e.id]?.population,isNaN(e.value)?"grey":energyType[selectedEnergyType].colorScale(e.value)},i=()=>{countryListBox.innerHTML="";for(const e of t[0].features){const t=e.id,n=e.properties.name,l=document.createElement("input");l.type="checkbox",l.value=t,l.checked=!!selectedCountries.includes(t),l.addEventListener("change",(()=>{r({id:t})}));const a=document.createElement("label");a.appendChild(l),a.appendChild(document.createTextNode(n));const i=document.createElement("li");i.appendChild(a),countryListBox.appendChild(i)}};yearSlider.addEventListener("input",(()=>{updatePieChart(data.get(yearSlider.value),selectedEnergyType,selectedCountries),i(yearSlider.value),d.selectAll("path").attr("fill",(function(e){return a(e,yearSlider.value)})),mapTitle.innerText=energyType[selectedEnergyType].title(yearSlider.value)}));for(let e=0;e<energyBtn.length;e++)energyBtn[e].addEventListener("click",(()=>{selectedEnergyType=energyBtn[e].getAttribute("energy-type"),o(),d.selectAll("path").attr("fill",(function(e){return a(e,yearSlider.value)})),mapTitle.innerText=energyType[selectedEnergyType].title(yearSlider.value),updatePieChart(data.get(yearSlider.value),selectedEnergyType,selectedCountries)}));d3MapSvg.append("rect").attr("class","map-background").attr("width",width).attr("height",height).on("click",l),mapTitle.innerText=energyType[selectedEnergyType].title(yearSlider.value);const d=d3MapSvg.append("g").attr("class","world");d.selectAll("path").data(t[0].features).enter().append("path").attr("d",d3.geoPath().projection(projection)).attr("data-name",(function(e){return e.properties.name})).attr("fill",(function(e){return a(e,yearSlider.value)})).style("stroke","transparent").attr("class","Country").attr("id",(function(e){return e.id})).style("opacity",1).on("mouseover",(function(e){0===selectedCountries.length&&n(d3.selectAll(".Country"),.5,"transparent"),n(d3.select(this),1,"black"),tooltip.style("left",d3.event.pageX+15+"px").style("top",d3.event.pageY-28+"px").transition().duration(400).style("opacity",1).text(`${e.properties.name}\r\n Total: ${e.value?e.value.toFixed(2)+" "+energyType[selectedEnergyType].unit:"NA"}\r\n Per Capita: ${e.value&&e.population?(1e6*e.value/e.population).toFixed(2)+" "+energyType[selectedEnergyType].perCapitaUnit:"NA"}`)})).on("mouseleave",(function(e){selectedCountries.length>0?selectedCountries.includes(e.id)||n(d3.select(this),.5,"transparent"):n(d3.selectAll(".Country"),1,"transparent"),tooltip.transition().duration(300).style("opacity",0)})).on("click",r),i();const o=()=>{const e=20;legend.selectAll("*").remove(),legend.append("text").attr("y",height-220).text(`${energyType[selectedEnergyType].legend}`);const t=legend.selectAll("g.legend").data(energyType[selectedEnergyType].colorScale.range().map((function(e){return null==(e=energyType[selectedEnergyType].colorScale.invertExtent(e))[0]&&(e[0]=x.domain()[0]),null==e[1]&&(e[1]=x.domain()[1]),e}))).enter().append("g").attr("class","legend_entry");t.append("rect").attr("y",(function(t,n){return height-(n+4)*e})).attr("width",e).attr("height",e).style("fill",(function(e){return energyType[selectedEnergyType].colorScale(e[0])})),t.append("text").attr("x",30).attr("y",(function(t,n){return height-(n+3)*e-4})).text((function(e,t){return 0===t?"< "+e[1]:e[1]<e[0]?e[0]+" +":e[0]+" - "+e[1]})),legend.append("rect").attr("y",height-60).attr("width",e).attr("height",e).style("fill","grey"),legend.append("text").attr("x",30).attr("y",height-40-3).text("NA")};o(),curveReady(data),mixReady(data),updatePieChart(data.get(yearSlider.value),selectedEnergyType,selectedCountries)}d3.queue().defer(d3.json,worldmap).defer(d3.json,oilData).awaitAll(ready);